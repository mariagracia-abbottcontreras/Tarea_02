---
title: "Tarea_02"
output: html_document
date: "2025-11-10"
editor_options: 
  chunk_output_type: inline
---

# 0. Cargar librerías

```{r}
library(tidyverse)
library(stringr)
library(stringi)
library(knitr)
library(kableExtra)
library(ggplot2)
library(forcats)
library(scales)

```



# 1. Base de datos
## 1.1  Importar base de datos

```{r}
df0 <- read_csv2(
  file = "../00_data/20250212_Rendimiento_2024_20250131_WEB.csv",
  col_select = c("MRUN", "ESTADO_ESTAB", "NOM_REG_RBD_A", "NOM_COM_ALU", "RURAL_RBD", "COD_DEPE2", "COD_ENSE2", "COD_GRADO", "GEN_ALU", "PROM_GRAL", "ASISTENCIA", "SIT_FIN_R"),
  locale = locale(encoding = "UTF-8")
) |> 
  filter(ESTADO_ESTAB == 1) |> 
  distinct(MRUN, .keep_all = TRUE)
```
- En este paso importamos la base de datos con las columnas de interés. 
- Nos aseguramos con la variable `MRUN`y la función`distinct`que solamente exista una observación por estudiante. Es decir, eliminamos los duplicados.


## 1.2. Limpiar y cambiar nombres variables y formatos textos

```{r}
janitor::clean_names(df0)
colnames(df0)


df1 <- df0 |> 
  select("NOM_REG_RBD_A", "NOM_COM_ALU", "RURAL_RBD", "COD_DEPE2", "COD_ENSE2", "COD_GRADO", "GEN_ALU", "PROM_GRAL", "ASISTENCIA", "SIT_FIN_R") |> 
  rename(
    region = NOM_REG_RBD_A,
    comuna = NOM_COM_ALU,
    rural_urbano = RURAL_RBD,
    tipo_dependencia = COD_DEPE2,
    nivel_enseñanza = COD_ENSE2,
    curso = COD_GRADO,
    genero = GEN_ALU,
    promedio = PROM_GRAL,
    porc_asistencia = ASISTENCIA,
    situacion_final = SIT_FIN_R) |> 
   mutate(
    across(
      c(region, comuna),
      ~ .x |> 
      str_to_lower() |> 
      stri_trans_general("Latin-ASCII") |> 
      str_trim() |> 
      str_squish()
         ))

head(df1)

```

## 1.3. Cambiar códigos de observaciones
```{r}
df2 <- df1 |> 
  mutate(
    rural_urbano = factor(
      rural_urbano,
      levels = c(0, 1),
      labels = c("urbano",
                 "rural")
    ),
    tipo_dependencia = factor(
      tipo_dependencia, 
      levels = c(1, 2, 3, 4, 5),
      labels = c("municipal",
                 "particular subvencionado",
                 "particular pagado",
                 "corporacion admin. delegada",
                 "servicio local de educación")
    ),
   nivel_curso = case_when(
      nivel_enseñanza == 2 & curso %in% 1:8 ~ paste0(curso, "° Básico"),
      nivel_enseñanza %in% c(5, 6) ~ paste0(curso, "° Medio HC"),
      nivel_enseñanza %in% c(7, 8) ~ paste0(curso, "° Medio TP"),
      nivel_enseñanza == 3 ~ "Adultos Básica",
      nivel_enseñanza == 6 ~ "Adultos Media HC",
      nivel_enseñanza == 8 ~ "Adultos Media TP",
      nivel_enseñanza == 4 ~ "Educación Especial",
      TRUE ~ "Otro / Sin info"
    ),
    nivel_enseñanza = factor(
      nivel_enseñanza, 
      levels = c(2, 3, 4, 5, 6, 7, 8),
      labels = c("Enseñanza Básica Niños",
                 "Enseñanza Básica Adultos",
                 "Educación Especial",
                 "Enseñanza Media HC Jóvenes",
                 "Enseñanza Media HC Adultos",
                 "Enseñanza Media TP Jóvenes",
                 "Enseñanza Media TP Adultos")
    ),
  nivel_curso = factor(nivel_curso),
  genero = factor(
      genero, 
      levels = c(0, 1, 2, 3),
      labels = c("indefinido",
                 "masculino",
                 "femenino",
                 "no binario")
    ),
  situacion_final = case_when(
    situacion_final == "P" ~ "Promovido",
    situacion_final == "R" ~ "Reprobado",
    situacion_final == "Y" ~ "Retirado",
    situacion_final == "T" ~ "Trasladado",
    situacion_final == "" ~ "Sin informacion"
    )
  ) |> 
  select("region", "comuna", "rural_urbano", "tipo_dependencia", "nivel_enseñanza","nivel_curso", "genero", "promedio", "porc_asistencia", "situacion_final")

head(df2)

write.csv(df2, "../00_data/rendimiento_2024_final.csv", row.names = FALSE)

```


# 2. Análisis de datos

## 2.1 Situación final con indicador de traslado según tipo de dependencia administrativa

### 2.1.1 Tabla de frecuencias

```{r}
sit_fin_dep <- rendimiento_2024_final |> 
  count(tipo_dependencia, situacion_final) |> 
  group_by(tipo_dependencia) |> 
  mutate(n_total = sum(n),
         porcentaje = round(n / sum(n) * 100, 2)) |> 
  ungroup() |> 
  select(tipo_dependencia, situacion_final, n, porcentaje) |> 
  arrange(tipo_dependencia, porcentaje) |> 
  mutate(situacion_final = factor(situacion_final, levels = unique(situacion_final))) |> 
  select(tipo_dependencia, situacion_final, n, porcentaje)


kable(sit_fin_dep,
      col.names = c("Dependencia", "Situación Final", "N", "%"),
      caption = "Situación Final por Dependencia Administrativa (2024)") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  pack_rows(index = table(fct_inorder(sit_fin_dep$tipo_dependencia)), latex_gap_space = "0.5em")

```

### 2.1.2  Gráfico

```{r}
ggplot(sit_fin_dep, aes(x = tipo_dependencia, y = porcentaje, fill = situacion_final)) +
  geom_col(position = "fill", width = 0.7) +
  geom_text(aes(label = ifelse(porcentaje >= 3, paste0(porcentaje, "%"), "")),
            position = position_fill(vjust = 0.5), size = 3.5, color = "white", fontface = "bold") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = c(
    "Promovido" = "#2E86AB",
    "Reprobado" = "#A23B72",
    "Retirado"  = "#F18F01",
    "Trasladado" = "#C73E1D",
    "Sin info"  = "#6B7280"
  )) +
  labs(
    title = "Situación Final por Dependencia Administrativa",
    subtitle = "Establecimientos funcionando | Año 2024 | Fuente: CEM Mineduc",
    x = "Tipo de Dependencia",
    y = "Porcentaje de estudiantes",
    fill = "Situación Final"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "right"
  )

ggsave("../02_output/situacion_final_tipo_dependencia_plot.png",
       width = 10, height = 6)

```


# Promedio general de notas según nivel de enseñanza por dependencia 

```{r}
prom_nivel_dep <- rendimiento_2024_final |> 
group_by(nivel_enseñanza, tipo_dependencia) %>%
  summarise(
    promedio = round(mean(promedio, na.rm = TRUE), 1),
    n_estudiantes = n()
  ) %>%
  arrange(nivel_enseñanza, tipo_dependencia)

  
```

```{r}
kable(prom_nivel_dep,
      col.names = c("Nivel de enseñanza", "Dependencia", "Promedio general", "N estudiantes"),
      caption = "Promedio general de notas por nivel de enseñanza y tipo de dependencia") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))
```


# Gráfico
```{r}
graf_promedios <- ggplot(prom_nivel_dep,
                         aes(x = nivel_enseñanza,
                             y = promedio,
                             fill = tipo_dependencia)) +
  geom_col(position = "dodge", width = 0.9) +
  geom_text(aes(label = promedio),
            position = position_dodge(width = 0.9),
            vjust = -0.3,
            size = 4,
            fontface = "bold") +
  labs(
    title = "Promedio general de notas por nivel de enseñanza y dependencia",
    x = "Nivel de enseñanza",
    y = "Promedio general",
    fill = "Tipo de dependencia",
    caption = "Elaboración propia con datos públicos del Centro de Estudios del Ministerio de Educación"
  ) +
  scale_y_continuous(expand = expansion(mult = c(0, 0.1))) +
  theme_minimal(base_size = 11) +
  theme(
    axis.text.x = element_text(angle = 30, hjust = 1, face = "bold"),
    plot.title = element_text(size = 15, face = "bold", hjust = 0.5)
  )


ggsave(filename = "grafico_promedio_nivel_dependencia.png", plot = graf_promedios, path = "02_output", width = 12, height = 7, dpi = 300, bg = "white")  

```


# Promedio general de notas por tramos según tipo de dependencia

```{r}
prom_tramos <- rendimiento_2024_final |> 
  mutate(tramo_promedio = case_when(
    promedio < 4.0                    ~ "Menor a 4.0 (Reprobado)",
    promedio >= 4.0 & promedio <= 7.0 ~ "4.0 a 7.0 (Aprobado)",
    is.na(promedio)                   ~ NA_character_,
    TRUE                              ~ "Otro"
  )) |> 
  count(nivel_enseñanza, tipo_dependencia, tramo_promedio, name = "n_estudiantes") |>
  group_by(nivel_enseñanza, tipo_dependencia) |> 
  mutate(
    total_por_grupo = sum(n_estudiantes, na.rm = TRUE),
    porcentaje = round(n_estudiantes / total_por_grupo * 100, 1)
  ) |>
  ungroup() |> 
  filter(!is.na(tramo_promedio)) |>
  arrange(nivel_enseñanza, tipo_dependencia, desc(tramo_promedio)) |> 
  select(
    `Nivel de enseñanza` = nivel_enseñanza,
    Dependencia = tipo_dependencia,
    `Tramo de promedio` = tramo_promedio,
    `N estudiantes` = n_estudiantes,
    Porcentaje = porcentaje
  )

kable(prom_tramos,
     caption = "Porcentaje de estudiantes según tramo de promedio por nivel y dependencia administrativa | Año 2024") %>%
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"))


```


# Gráfico 

```{r}
ggplot(prom_tramos, aes(x = Dependencia, 
                        y = Porcentaje, 
                        fill = `Tramo de promedio`)) +
  geom_col(width = 0.6) +
  facet_wrap(~ `Nivel de enseñanza`) +        # ←←← AQUÍ ESTÁ EL FIX
  scale_fill_manual(values = c(
    "Menor a 4.0 (Reprobado)" = "#e74c3c",    # rojo
    "4.0 a 7.0 (Aprobado)"    = "#27ae60"     # verde
  )) +
  scale_y_continuous(labels = percent_format(scale = 1)) +
  labs(title = "Porcentaje de estudiantes según tramo de promedio",
       subtitle = "Por nivel de enseñanza y dependencia | 2024",
       x = NULL, y = NULL, fill = "Tramo") +
  theme_minimal(base_size = 13) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "top",
        panel.grid = element_blank())

```


# Cantidad de establecimientos según dependencia 

### 2.1.1 Tablas de frecuencia

```{r}
rendimiento_2024_final %>%
  count(tipo_dependencia, name = "Total") %>%
  mutate(`%` = round(Total / sum(Total) * 100, 1)) %>%
  arrange(desc(Total)) %>%
  kable(col.names = c("Tipo de Establecimiento según Dependencia", "Total", "%"))
```

# Cantidad de estudiantes por curso (tabla de frecuencias)
```{r}
df2 %>%
  count(nivel_curso, name = "Total") %>%
  mutate(`%` = round(Total / sum(Total) * 100, 1)) %>%
  arrange(desc(Total)) %>%
  kable(col.names = c("Nivel y Curso", "Total", "%"))
```


# Cantidad de estudiantes por curso según modalidad (HC o TP)
```{r}
df3 <- rendimiento_2024_final |> 
   mutate(
    curso = case_when(
      grepl("Medio", nivel_curso) ~ sub(" (HC|TP)$", "", nivel_curso),  # ejemplo: "1° Medio HC" → "1° Medio"
      TRUE ~ nivel_curso
    ),
    tipo = case_when(
      grepl("HC", nivel_curso) ~ "HC",
      grepl("TP", nivel_curso) ~ "TP",
      TRUE ~ "Básico"
    )
  )

```

# tabla de frecuencias 

```{r}
tabla_frec <- df3 %>%
  filter(tipo %in% c("HC", "TP")) %>%   # solo cursos medios comparables
  count(curso, tipo) %>%
  group_by(curso) %>%
  mutate(
    porcentaje = round(n / sum(n) * 100, 1)
  ) %>%
  ungroup() %>%
  arrange(curso, tipo)

kable(tabla_frec,
      col.names = c("Curso", "Tipo", "N", "%"),
      caption = "Distribución de estudiantes por curso y tipo (HC vs TP)") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))


```

# Gráfico

```{r}

graf_HC_TP_N <- ggplot(tabla_frec, aes(x = curso, y = n, fill = tipo)) + 
  geom_col(position = "dodge", width = 0.6) + 
  geom_text(
    aes(label = scales::comma(n)),
    position = position_dodge(width = 0.6),
    vjust = -0.3,
    size = 4,
    fontface = "bold"
  ) +
  scale_fill_manual(values = c(
    "HC" = "lightgreen",
    "TP" = "orange"
  )) +
  labs(
    title = "Distribución de estudiantes en Enseñanza Media por curso y tipo (2024)",
    x = "Curso",
    y = "Número de estudiantes",
    fill = "Tipo",
    caption = "Elaboración propia con datos públicos del Centro de Estudios del Ministerio de Educación de Chile"
  ) +
  scale_y_continuous(labels = scales::comma,
                     expand = expansion(mult = c(0, 0.1))) +
  theme_minimal(base_size = 10) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )


ggsave(filename = "grafico_comparativo_media_2024_2_n.png", plot = graf_HC_TP_N, path = "02_output", width = 12, height = 7, dpi = 300, bg = "white")  

```


# Asistencia

```{r}
asistencia <- rendimiento_2024_final |> 
  group_by(nivel_enseñanza, tipo_dependencia) |> 
  summarise(
    prom_asistencia = round(mean(porc_asistencia, na.rm = T), 1),
    n_estudiantes = n(),
    .groups = "drop"
  ) |> 
  arrange(nivel_enseñanza, desc(prom_asistencia))

asistencia |>
  kable(col.names = c("Nivel de enseñanza", "Dependencia", 
                      "Promedio asistencia (%)", "N estudiantes"),
        caption = "Promedio de asistencia por nivel de enseñanza y dependencia | Año 2024") |>
  kable_styling(bootstrap_options = c("striped", "hover", "condensed"), 
                full_width = FALSE, font_size = 13) |>
  row_spec(0, bold = TRUE, background = "#2c3e50", color = "white")
```

# Gráfico 
```{r}
graf_asistencia <- ggplot(asistencia, aes(x = tipo_dependencia, 
                             y = prom_asistencia, 
                             fill = tipo_dependencia)) +
  geom_col(width = 0.65) +
  
  # Etiqueta con el % arriba de cada barra
  geom_text(aes(label = paste0(prom_asistencia, "%")), 
            vjust = -0.5, fontface = "bold", size = 4) +
  
  # Separar por nivel
  facet_wrap(~ nivel_enseñanza, ncol = 3) +
  
  # Colores suaves y agradables (puedes cambiarlos fácil)
  scale_fill_manual(values = c(
    "Municipal"                   = "#3498db",
    "Particular Subvencionado"    = "#2ecc71",
    "Particular Pagado"           = "#e74c3c",
    "Corporación Administración"  = "#9b59b6",
    "Servicio Local de Educación" = "#f1c40f",
    "Otro"                        = "#95a5a6"
  )) +
  
  scale_y_continuous(limits = c(0, 100), labels = percent_format(scale = 1)) +
  
  labs(title = "Promedio de asistencia por nivel de enseñanza y dependencia",
       subtitle = "Chile | Año 2024",
       x = NULL, y = NULL,
       caption = "Fuente: Rendimiento 2024 Mineduc") +
  
  theme_minimal(base_size = 13) +
  theme(
    legend.position = "none",                    # quitamos leyenda porque ya está en el eje x
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title = element_text(face = "bold", hjust = 0.5),
    strip.text = element_text(face = "bold")
  )


ggsave(filename = "grafico_asistencia.png", plot = graf_asistencia, path = "02_output", width = 12, height = 7, dpi = 300, bg = "white")  


```

