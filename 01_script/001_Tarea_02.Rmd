---
title: "Tarea_02"
output: html_document
date: "2025-11-10"
editor_options: 
  chunk_output_type: console
---

# 0. Cargar librerías

```{r}
library(tidyverse)
library(stringr)
library(stringi)
library(knitr)
library(kableExtra)
library(ggplot2)
library(forcats)

```



# 1. Base de datos
## 1.1  Importar base de datos

```{r}
df0 <- read_csv2(
  file = "../00_data/20250212_Rendimiento_2024_20250131_WEB.csv",
  col_select = c("MRUN", "ESTADO_ESTAB", "NOM_REG_RBD_A", "NOM_COM_ALU", "RURAL_RBD", "COD_DEPE2", "COD_ENSE2", "COD_GRADO", "GEN_ALU", "PROM_GRAL", "ASISTENCIA", "SIT_FIN_R"),
  locale = locale(encoding = "UTF-8")
) |> 
  filter(ESTADO_ESTAB == 1) |> 
  distinct(MRUN, .keep_all = TRUE)
```
- En este paso importamos la base de datos con las columnas de interés. 
- Nos aseguramos con la variable `MRUN`y la función`distinct`que solamente exista una observación por estudiante. Es decir, eliminamos los duplicados.


## 1.2. Limpiar y cambiar nombres variables y formatos textos

```{r}
janitor::clean_names(df0)
colnames(df0)


df1 <- df0 |> 
  select("NOM_REG_RBD_A", "NOM_COM_ALU", "RURAL_RBD", "COD_DEPE2", "COD_ENSE2", "COD_GRADO", "GEN_ALU", "PROM_GRAL", "ASISTENCIA", "SIT_FIN_R") |> 
  rename(
    region = NOM_REG_RBD_A,
    comuna = NOM_COM_ALU,
    rural_urbano = RURAL_RBD,
    tipo_dependencia = COD_DEPE2,
    nivel_enseñanza = COD_ENSE2,
    curso = COD_GRADO,
    genero = GEN_ALU,
    promedio = PROM_GRAL,
    porc_asistencia = ASISTENCIA,
    situacion_final = SIT_FIN_R) |> 
   mutate(
    across(
      c(region, comuna),
      ~ .x |> 
      str_to_lower() |> 
      stri_trans_general("Latin-ASCII") |> 
      str_trim() |> 
      str_squish()
         ))

head(df1)

```

## 1.3. Cambiar códigos de observaciones
```{r}
df2 <- df1 |> 
  mutate(
    rural_urbano = factor(
      rural_urbano,
      levels = c(0, 1),
      labels = c("urbano",
                 "rural")
    ),
    tipo_dependencia = factor(
      tipo_dependencia, 
      levels = c(1, 2, 3, 4, 5),
      labels = c("municipal",
                 "particular subvencionado",
                 "particular pagado",
                 "corporacion admin. delegada",
                 "servicio local de educación")
    ),
    nivel_curso = case_when(
      nivel_enseñanza == 2 & curso %in% 1:8 ~ paste0(curso, "° Básico"),
      nivel_enseñanza %in% c(5, 6) ~ paste0(curso, "° Medio HC"),
      nivel_enseñanza %in% c(7, 8) ~ paste0(curso, "° Medio TP"),
      nivel_enseñanza == 3 ~ "Adultos Básica",
      nivel_enseñanza == 6 ~ "Adultos Media HC",
      nivel_enseñanza == 8 ~ "Adultos Media TP",
      nivel_enseñanza == 4 ~ "Educación Especial",
      TRUE ~ "Otro / Sin info"
    ),
  nivel_curso = factor(nivel_curso),
  genero = factor(
      genero, 
      levels = c(0, 1, 2, 3),
      labels = c("indefinido",
                 "masculino",
                 "femenino",
                 "no binario")
    ),
  situacion_final = case_when(
    situacion_final == "P" ~ "Promovido",
    situacion_final == "R" ~ "Reprobado",
    situacion_final == "Y" ~ "Retirado",
    situacion_final == "T" ~ "Trasladado",
    situacion_final == "" ~ "Sin informacion"
    )
  ) |> 
  select("region", "comuna", "rural_urbano", "tipo_dependencia", "nivel_curso", "genero", "promedio", "porc_asistencia", "situacion_final")

head(df2)

write.csv(df2, "../00_data/rendimiento_2024_final.csv", row.names = FALSE)

```


# 2. Análisis de datos

## 2.1 Situación final con indicador de traslado según tipo de dependencia administrativa

### 2.1.1 Tabla de frecuencias

```{r}
sit_fin_dep <- df2 |> 
  count(tipo_dependencia, situacion_final) |> 
  group_by(tipo_dependencia) |> 
  mutate(n_total = sum(n),
         porcentaje = round(n / sum(n) * 100, 2)) |> 
  ungroup() |> 
  select(tipo_dependencia, situacion_final, n, porcentaje) |> 
  arrange(tipo_dependencia, porcentaje) |> 
  mutate(situacion_final = factor(situacion_final, levels = unique(situacion_final))) |> 
  select(tipo_dependencia, situacion_final, n, porcentaje)


kable(sit_fin_dep,
      col.names = c("Dependencia", "Situación Final", "N", "%"),
      caption = "Situación Final por Dependencia Administrativa (2024)") %>%
  kable_styling(bootstrap_options = c("striped", "hover")) %>%
  pack_rows(index = table(fct_inorder(sit_fin_dep$tipo_dependencia)), latex_gap_space = "0.5em")

```

### 2.1.2  Gráfico

```{r}
ggplot(sit_fin_dep, aes(x = tipo_dependencia, y = porcentaje, fill = situacion_final)) +
  geom_col(position = "fill", width = 0.7) +
  geom_text(aes(label = ifelse(porcentaje >= 3, paste0(porcentaje, "%"), "")),
            position = position_fill(vjust = 0.5), size = 3.5, color = "white", fontface = "bold") +
  scale_y_continuous(labels = scales::percent_format()) +
  scale_fill_manual(values = c(
    "Promovido" = "#2E86AB",
    "Reprobado" = "#A23B72",
    "Retirado"  = "#F18F01",
    "Trasladado" = "#C73E1D",
    "Sin info"  = "#6B7280"
  )) +
  labs(
    title = "Situación Final por Dependencia Administrativa",
    subtitle = "Establecimientos funcionando | Año 2024 | Fuente: CEM Mineduc",
    x = "Tipo de Dependencia",
    y = "Porcentaje de estudiantes",
    fill = "Situación Final"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(face = "bold", hjust = 0.5),
    axis.text.x = element_text(angle = 45, hjust = 1),
    legend.position = "right"
  )

ggsave("../02_output/situacion_final_tipo_dependencia_plot.png",
       width = 10, height = 6)

```


# Cantidad de establecimientos según dependencia 

### 2.1.1 Tablas de frecuencia

```{r}
df2 %>%
  count(tipo_dependencia, name = "Total") %>%
  mutate(`%` = round(Total / sum(Total) * 100, 1)) %>%
  arrange(desc(Total)) %>%
  kable(col.names = c("Tipo de Establecimiento según Dependencia", "Total", "%"))
```

# Cantidad de estudiantes por curso (tabla de frecuencias)
```{r}
df2 %>%
  count(nivel_curso, name = "Total") %>%
  mutate(`%` = round(Total / sum(Total) * 100, 1)) %>%
  arrange(desc(Total)) %>%
  kable(col.names = c("Nivel y Curso", "Total", "%"))
```


# Otra tabla de frecuencia
```{r}
df3 <- df2 |> 
   mutate(
    curso = case_when(
      grepl("Medio", nivel_curso) ~ sub(" (HC|TP)$", "", nivel_curso),  # ejemplo: "1° Medio HC" → "1° Medio"
      TRUE ~ nivel_curso
    ),
    tipo = case_when(
      grepl("HC", nivel_curso) ~ "HC",
      grepl("TP", nivel_curso) ~ "TP",
      TRUE ~ "Básico"
    )
  )

tabla_frec <- df3 %>%
  filter(tipo %in% c("HC", "TP")) %>%   # solo cursos medios comparables
  count(curso, tipo) %>%
  group_by(curso) %>%
  mutate(
    porcentaje = round(n / sum(n) * 100, 1)
  ) %>%
  ungroup() %>%
  arrange(curso, tipo)

kable(tabla_frec,
      col.names = c("Curso", "Tipo", "N", "%"),
      caption = "Distribución de estudiantes por curso y tipo (HC vs TP)") %>%
  kable_styling(bootstrap_options = c("striped", "hover"))


```

# Gráfico

```{r}

graf_HC_TP_N <- ggplot(tabla_frec, aes(x = curso, y = n, fill = tipo)) + 
  geom_col(position = "dodge", width = 0.6) + 
  geom_text(
    aes(label = scales::comma(n)),
    position = position_dodge(width = 0.6),
    vjust = -0.3,
    size = 4,
    fontface = "bold"
  ) +
  scale_fill_manual(values = c(
    "HC" = "lightgreen",
    "TP" = "orange"
  )) +
  labs(
    title = "Distribución de estudiantes en Enseñanza Media por curso y tipo (2024)",
    x = "Curso",
    y = "Número de estudiantes",
    fill = "Tipo",
    caption = "Elaboración propia con datos públicos del Centro de Estudios del Ministerio de Educación de Chile"
  ) +
  scale_y_continuous(labels = scales::comma,
                     expand = expansion(mult = c(0, 0.1))) +
  theme_minimal(base_size = 10) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, face = "bold"),
    plot.title = element_text(size = 16, face = "bold", hjust = 0.5)
  )


ggsave(filename = "grafico_comparativo_media_2024_n.png", plot = graf_HC_TP_N, path = "02_output", width = 12, height = 7, dpi = 300, bg = "white")  

```

